<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Parking - Thanh toán</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>Thanh toán</h1>
    </header>
    <section>
      <h2>Thông tin đơn hàng</h2>
      <p><strong>Chỗ đặt:</strong> <span id="booking-lot"></span></p>
      <p><strong>Thời gian đặt:</strong> <span id="booking-time"></span></p>
      <p><strong>Thời gian trả:</strong> <span id="return-time"></span></p>
      <p><strong>Số giờ đặt:</strong> <span id="booking-hours"></span> giờ</p>
      <p>
        <strong>Số tiền thanh toán:</strong> <span id="payment-amount"></span>
      </p>
      <p><strong>Mã đơn hàng:</strong> <span id="order-id"></span></p>

      <h2>Phương thức thanh toán</h2>
        <div id="payment-methods">
        <button id="sepayButton">Thanh toán qua SEPay</button>
        <p id="payment-status"></p>
      </div>
      <h2>Thông tin tài khoản</h2>
      <p><strong>Tên chủ tài khoản:</strong> Nguyễn Văn A</p>
      <p><strong>Số tài khoản:</strong> 123456789</p>
      <p><strong>Ngân hàng:</strong> Vietcombank</p>
      <button onclick="location.href='orientation.html'">
        Hoàn tất thanh toán
      </button>
    </section>
    <script>
      // Lấy thông tin đặt chỗ từ localStorage
      const bookingInfo = JSON.parse(localStorage.getItem("bookingInfo"));

      if (bookingInfo) {
        // Hiển thị thông tin đơn hàng
        document.getElementById("booking-lot").textContent = bookingInfo.lot;
        document.getElementById("booking-time").textContent =
          bookingInfo.bookingTime;
        document.getElementById("return-time").textContent =
          bookingInfo.returnTime;

        // Tính số giờ đặt chỗ
        const bookingTime = new Date(bookingInfo.bookingTime);
        const returnTime = new Date(bookingInfo.returnTime);
        const hours = Math.ceil((returnTime - bookingTime) / (1000 * 60 * 60)); // Tính số giờ
        document.getElementById("booking-hours").textContent = hours;

        // Tính số tiền thanh toán (20,000đ/giờ)
        const paymentAmount = hours * 20000; // 20,000đ/giờ
        document.getElementById('sepayButton').addEventListener('click', async () => {
          const bookingInfo = JSON.parse(localStorage.getItem("bookingInfo"));
          if (!bookingInfo) {
            alert("Không có thông tin đặt chỗ!");
            return;
          }
        
          // Thông tin đơn hàng (tham khảo API SEPay thực tế)
          const orderInfo = {
            merchant_id: "9864",  // Thay bằng ID của bạn
            order_id: `ORDER-${Math.floor(Math.random() * 1000000)}`,
            amount: bookingInfo.hours * 20000,  // Giả sử 20,000đ/giờ
            description: `Đặt chỗ bãi ${bookingInfo.lot}`,
            callback_url: "https://xenontnt2703.github.io/smart-parking/", // URL nhận webhook
            return_url: "orientation.html"  // Chuyển hướng sau thanh toán
          };
        
          try {
            // Giả sử SEPay có endpoint /create_payment (kiểm tra tài liệu thực tế)
            const response = await fetch('https://api.sepay.vn/create_payment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(orderInfo)
            });
        
            const data = await response.json();
            if (data.payment_url) {
              window.location.href = data.payment_url; // Chuyển đến trang SEPay
            } else {
              document.getElementById('payment-status').textContent = "Lỗi: " + data.error;
            }
          } catch (error) {
            document.getElementById('payment-status').textContent = "Lỗi kết nối!";
          }
        });}
    </script>
    
  </body>
</html>
